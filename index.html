<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TOKYO TRIP (Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#121212',       // 極深黑
                        'dark-card': '#1E1E1E',     // 卡片深灰
                        'dark-input': '#2C2C2C',    // 輸入框灰
                        'neon-blue': '#4CC9F0',     // 螢光藍 (Eric)
                        'neon-pink': '#F72585',     // 螢光粉 (Clement)
                        'neon-gold': '#FFD700',     // 金色 (重點)
                        'text-main': '#E0E0E0',     // 主要文字
                        'text-sub': '#A0A0A0',      // 次要文字
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #121212; color: #E0E0E0; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Dark Theme Inputs */
        input, select, textarea { 
            border: 1px solid #333; 
            border-radius: 12px; 
            padding: 12px; 
            width: 100%; 
            background: #2C2C2C;
            color: white;
            outline: none;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus { border-color: #4CC9F0; }
        
        .nav-active { color: #4CC9F0; font-weight: bold; text-shadow: 0 0 10px rgba(76, 201, 240, 0.3); }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        
        /* Modal Animation */
        .slide-up-anim { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Loader */
        .loader { border: 3px solid #333; border-top: 3px solid #4CC9F0; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-24 font-sans antialiased selection:bg-neon-blue selection:text-black">

    <div class="fixed top-0 w-full bg-dark-bg/95 backdrop-blur-md z-50 px-6 py-4 flex justify-between items-center border-b border-gray-800">
        <h1 class="text-xl font-bold tracking-widest text-white">TOKYO <span class="text-xs font-normal ml-1 text-neon-blue">SYNC</span></h1>
        <div class="flex items-center gap-2 bg-dark-input px-3 py-1 rounded-full border border-gray-700">
            <span class="text-xs text-text-sub">匯率</span>
            <input type="number" id="exchangeRate" value="0.053" step="0.001" class="w-16 text-right border-none p-0 text-sm font-bold bg-transparent focus:ring-0 text-neon-gold">
        </div>
        <div id="connectionStatus" class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_5px_red]"></div>
    </div>

    <div class="mt-20 px-4">
        
        <div id="itinerarySection">
            <div class="flex overflow-x-auto gap-3 pb-4 hide-scrollbar" id="dateScroller"></div>

            <button onclick="window.toggleModal('planModal')" class="w-full bg-gradient-to-r from-gray-800 to-gray-700 text-white border border-gray-600 py-3 rounded-xl shadow-lg mb-6 flex items-center justify-center gap-2 active:scale-95 transition">
                <i class="fas fa-plus text-neon-blue"></i> 新增行程
            </button>

            <div id="planList" class="space-y-4 min-h-[200px]">
                <div class="flex justify-center mt-10"><div class="loader"></div></div>
            </div>

            <button onclick="window.resetData('plans')" class="w-full mt-12 border border-red-900/50 text-red-700 bg-red-900/10 py-3 rounded-xl text-sm mb-4 hover:bg-red-900/20 transition">
                <i class="fas fa-trash"></i> 清空所有行程
            </button>
        </div>

        <div id="walletSection" class="hidden">
            
            <button onclick="window.toggleModal('expenseModal')" class="w-full bg-neon-gold text-black font-bold py-3 rounded-xl shadow-[0_0_15px_rgba(255,215,0,0.3)] mb-6 flex items-center justify-center gap-2 active:scale-95 transition">
                <i class="fas fa-receipt"></i> 記一筆 (日元)
            </button>

            <div class="bg-dark-card p-5 rounded-2xl card-shadow mb-6 border border-gray-800">
                <h2 class="font-bold text-lg mb-4 flex items-center gap-2 text-white"><i class="fas fa-chart-pie text-neon-blue"></i> 消費總結 (HKD)</h2>
                
                <div class="flex items-center justify-between mb-6">
                    <div class="w-1/2 relative">
                        <canvas id="userChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span class="text-xs text-gray-500 font-bold">Total</span>
                        </div>
                    </div>
                    <div class="w-1/2 pl-4 text-sm">
                        <div class="flex justify-between mb-2"><span class="text-neon-blue font-bold">Eric</span> <span id="ericTotalDisp" class="font-mono text-white">0</span></div>
                        <div class="flex justify-between mb-2"><span class="text-neon-pink font-bold">Clement</span> <span id="clementTotalDisp" class="font-mono text-white">0</span></div>
                        <div class="border-t border-gray-700 my-2"></div>
                        <div class="flex justify-between"><span class="text-text-sub">Total</span> <span id="grandTotalDisp" class="font-bold text-neon-gold font-mono">0</span></div>
                    </div>
                </div>
            </div>

            <div class="bg-dark-card p-5 rounded-2xl card-shadow mb-6 border border-gray-800">
                <h2 class="font-bold text-lg mb-2 flex items-center gap-2 text-white"><i class="fas fa-credit-card text-green-400"></i> 回贈分析</h2>
                <div class="flex gap-2 text-[10px] text-gray-400 mb-4">
                    <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-gray-600 mr-1"></span>未達標</span>
                    <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-green-500 mr-1"></span>合資格</span>
                    <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-red-500 mr-1"></span>爆額</span>
                </div>
                
                <div id="cardsContainer" class="grid grid-cols-1 gap-6">
                    </div>

                <div class="mt-6 bg-dark-bg p-4 rounded-xl border border-gray-700 flex justify-between items-center">
                    <span class="font-bold text-gray-400 text-sm">預計現金回贈</span>
                    <span class="text-xl font-bold text-green-400 font-mono">HKD <span id="totalRebateDisp">0</span></span>
                </div>
            </div>

            <div class="space-y-4" id="ledgerList"></div>
            
            <button onclick="window.resetData('expenses')" class="w-full mt-8 border border-red-900/50 text-red-700 bg-red-900/10 py-3 rounded-xl text-sm mb-10 hover:bg-red-900/20 transition">
                <i class="fas fa-trash"></i> 重置記帳資料
            </button>
        </div>
    </div>

    <div class="fixed bottom-0 w-full bg-dark-card border-t border-gray-800 flex justify-around py-3 pb-6 z-50">
        <button onclick="window.switchTab('itinerary')" id="btnItinerary" class="flex flex-col items-center nav-active transition">
            <i class="fas fa-map-marked-alt text-xl mb-1"></i>
            <span class="text-xs">行程</span>
        </button>
        <button onclick="window.switchTab('wallet')" id="btnWallet" class="flex flex-col items-center text-gray-600 transition">
            <i class="fas fa-wallet text-xl mb-1"></i>
            <span class="text-xs">記帳</span>
        </button>
    </div>

    <div id="planModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-dark-card w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl border-t border-gray-700 slide-up-anim">
            <h3 class="font-bold text-lg mb-4 text-white">新增行程</h3>
            <div class="space-y-3">
                <input type="date" id="planDate">
                <input type="time" id="planTime">
                <input type="text" id="planLoc" placeholder="地點 (Google Map 搜尋關鍵字)">
                <input type="text" id="planActivity" placeholder="活動內容">
                <textarea id="planNote" placeholder="備註 (巴士/火車時間)" rows="2"></textarea>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="window.toggleModal('planModal')" class="flex-1 py-3 rounded-xl bg-gray-700 text-gray-300">取消</button>
                <button onclick="window.addPlan()" class="flex-1 py-3 rounded-xl bg-neon-blue text-black font-bold">儲存</button>
            </div>
        </div>
    </div>

    <div id="expenseModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-dark-card w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl border-t border-gray-700 slide-up-anim">
            <h3 class="font-bold text-lg mb-4 text-white">新增消費 (JPY)</h3>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <button onclick="window.setExpenseUser('Eric')" id="btnExpEric" class="flex-1 py-2 rounded-lg border border-neon-blue bg-neon-blue/20 text-neon-blue font-bold transition">Eric</button>
                    <button onclick="window.setExpenseUser('Clement')" id="btnExpClement" class="flex-1 py-2 rounded-lg border border-gray-700 text-gray-500 transition">Clement</button>
                </div>
                <input type="date" id="expDate">
                <input type="number" id="expAmount" placeholder="金額 (JPY)" inputmode="numeric">
                <input type="text" id="expItem" placeholder="項目 (例如: 晚餐)">
                <select id="expCard"></select>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="window.toggleModal('expenseModal')" class="flex-1 py-3 rounded-xl bg-gray-700 text-gray-300">取消</button>
                <button onclick="window.addExpense()" class="flex-1 py-3 rounded-xl bg-neon-gold text-black font-bold">記帳</button>
            </div>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
  apiKey: "AIzaSyAPf2xpEZsvUItkDAs_k7zYX7CCSMwQLlY",
  authDomain: "tokyotrip-7411b.firebaseapp.com",
  projectId: "tokyotrip-7411b",
  storageBucket: "tokyotrip-7411b.firebasestorage.app",
  messagingSenderId: "932169211628",
  appId: "1:932169211628:web:3ff2b89372e333a9784fc9",
  measurementId: "G-4RZY667C6S"
};
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            // 請將你的 Firebase Config 複製貼上覆蓋下方內容
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456:web:abcdef"
        };

        // Initialize Firebase
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            // Indicate connection success visually
            document.getElementById('connectionStatus').classList.remove('bg-red-500', 'shadow-[0_0_5px_red]');
            document.getElementById('connectionStatus').classList.add('bg-green-500', 'shadow-[0_0_5px_green]');
        } catch (e) {
            console.error("Firebase Config Error:", e);
            alert("Firebase 設定有誤，請檢查 HTML 原始碼中的 firebaseConfig 部分。");
        }

        // --- GLOBAL VARIABLES ---
        let plansData = [];
        let expensesData = [];
        let currentTab = 'itinerary';
        let expenseUser = 'Eric';

        // Card Rules
        const cardRules = {
            "Eric's MM power": { min: 5000, max: 8929, rate: 0.06 },
            "Clement's MM power": { min: 5000, max: 8929, rate: 0.06 },
            "恒生Travel+": { min: 6000, max: 7576, rate: 0.07 },
            "Sim card": { min: 1000, max: 2500, rate: 0.08 },
            "中銀chill": { min: 0, max: 3260, rate: 0.05 },
            "中銀cheers": { min: 5000, max: 25000, rate: 0.04 },
            "建行travo": { min: 0, max: 44444, rate: 0.04 }
        };

        // --- FIREBASE LISTENERS (READ DATA) ---
        if(db) {
            const plansRef = ref(db, 'plans');
            const expensesRef = ref(db, 'expenses');

            onValue(plansRef, (snapshot) => {
                const data = snapshot.val();
                plansData = data ? Object.entries(data).map(([key, val]) => ({...val, firebaseKey: key})) : [];
                // Sort by date + time
                plansData.sort((a,b) => (a.date + a.time).localeCompare(b.date + b.time));
                renderPlans();
            });

            onValue(expensesRef, (snapshot) => {
                const data = snapshot.val();
                expensesData = data ? Object.values(data) : [];
                updateWalletUI();
            });
        }

        // --- EXPOSE FUNCTIONS TO WINDOW (FOR HTML BUTTONS) ---
        window.switchTab = (tab) => {
            currentTab = tab;
            document.getElementById('itinerarySection').classList.toggle('hidden', tab !== 'itinerary');
            document.getElementById('walletSection').classList.toggle('hidden', tab !== 'wallet');
            
            const btnItinerary = document.getElementById('btnItinerary');
            const btnWallet = document.getElementById('btnWallet');

            if(tab === 'itinerary') {
                btnItinerary.className = 'flex flex-col items-center nav-active transition';
                btnItinerary.querySelector('i').classList.remove('text-gray-600');
                btnWallet.className = 'flex flex-col items-center text-gray-600 transition';
            } else {
                btnWallet.className = 'flex flex-col items-center nav-active transition text-neon-gold';
                btnItinerary.className = 'flex flex-col items-center text-gray-600 transition';
                updateWalletUI();
            }
        };

        window.toggleModal = (id) => {
            document.getElementById(id).classList.toggle('hidden');
        };

        window.setExpenseUser = (user) => {
            expenseUser = user;
            const btnE = document.getElementById('btnExpEric');
            const btnC = document.getElementById('btnExpClement');
            if(user === 'Eric') {
                btnE.className = 'flex-1 py-2 rounded-lg border border-neon-blue bg-neon-blue/20 text-neon-blue font-bold transition';
                btnC.className = 'flex-1 py-2 rounded-lg border border-gray-700 text-gray-500 transition';
            } else {
                btnE.className = 'flex-1 py-2 rounded-lg border border-gray-700 text-gray-500 transition';
                btnC.className = 'flex-1 py-2 rounded-lg border border-neon-pink bg-neon-pink/20 text-neon-pink font-bold transition';
            }
        };

        // --- ITINERARY ACTIONS ---
        window.addPlan = () => {
            const date = document.getElementById('planDate').value;
            const time = document.getElementById('planTime').value;
            const loc = document.getElementById('planLoc').value;
            const activity = document.getElementById('planActivity').value;
            const note = document.getElementById('planNote').value;

            if (!date || !activity) return alert('請填寫日期及活動');

            const newPlan = { date, time, loc, activity, note };
            push(ref(db, 'plans'), newPlan); // Firebase Push
            
            window.toggleModal('planModal');
            document.getElementById('planLoc').value = '';
            document.getElementById('planActivity').value = '';
            document.getElementById('planNote').value = '';
        };

        window.deletePlan = (key) => {
            if(confirm('確定刪除此行程?')) {
                remove(ref(db, `plans/${key}`));
            }
        };

        // --- WALLET ACTIONS ---
        window.addExpense = () => {
            const date = document.getElementById('expDate').value;
            const amount = parseFloat(document.getElementById('expAmount').value);
            const item = document.getElementById('expItem').value;
            const card = document.getElementById('expCard').value;
            
            if (!amount || !item) return alert('請填寫金額及項目');

            const newExp = { 
                date, 
                user: expenseUser, 
                amountJPY: amount, 
                item, 
                card 
            };
            push(ref(db, 'expenses'), newExp); // Firebase Push

            window.toggleModal('expenseModal');
            document.getElementById('expAmount').value = '';
            document.getElementById('expItem').value = '';
        };

        window.resetData = (type) => {
            if(confirm(`警告：確定清空所有 ${type === 'plans' ? '行程' : '記帳'} 資料嗎？其他人的手機也會同步刪除！`)) {
                set(ref(db, type), null); // Firebase Delete
            }
        };

        // --- RENDER LOGIC ---
        function renderPlans(filterDate = null) {
            const list = document.getElementById('planList');
            list.innerHTML = '';
            
            let displayPlans = plansData;
            if (filterDate) {
                displayPlans = plansData.filter(p => p.date === filterDate);
            }

            if (displayPlans.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-600 py-10 opacity-50">暫無行程</div>`;
                return;
            }

            displayPlans.forEach(p => {
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.loc)}`;
                const item = document.createElement('div');
                item.className = 'bg-dark-card p-4 rounded-xl card-shadow flex gap-4 border-l-4 border-neon-blue';
                item.innerHTML = `
                    <div class="flex flex-col items-center justify-center border-r pr-4 border-gray-700 min-w-[60px]">
                        <span class="text-xs text-text-sub">${p.date.substring(5).replace('-','/')}</span>
                        <span class="font-bold text-lg text-white">${p.time}</span>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-white text-lg">${p.activity}</h4>
                            <a href="${mapLink}" target="_blank" class="text-neon-blue"><i class="fas fa-map-marker-alt"></i></a>
                        </div>
                        <p class="text-sm text-text-sub mt-1"><i class="fas fa-map-pin text-xs mr-1"></i> ${p.loc}</p>
                        ${p.note ? `<div class="mt-2 bg-dark-bg p-2 rounded text-xs text-gray-400 border border-gray-800">${p.note}</div>` : ''}
                        <button onclick="window.deletePlan('${p.firebaseKey}')" class="text-xs text-red-400 mt-2 opacity-60 hover:opacity-100">刪除</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // Initialize Scroller
        const scroller = document.getElementById('dateScroller');
        const today = new Date();
        document.getElementById('planDate').value = today.toISOString().split('T')[0];
        document.getElementById('expDate').value = today.toISOString().split('T')[0];

        for (let i = 0; i < 14; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() + i);
            const dayStr = d.getDate();
            const weekStr = ['日','一','二','三','四','五','六'][d.getDay()];
            const fullDate = d.toISOString().split('T')[0];
            
            const btn = document.createElement('button');
            // Default styling
            const baseClass = "flex-shrink-0 w-14 h-16 rounded-xl flex flex-col items-center justify-center border transition";
            const activeClass = "bg-neon-blue text-black border-neon-blue shadow-[0_0_10px_rgba(76,201,240,0.5)]";
            const inactiveClass = "bg-dark-card text-gray-500 border-gray-700";
            
            btn.className = `${baseClass} ${i === 0 ? activeClass : inactiveClass}`;
            btn.innerHTML = `<span class="text-xs">${weekStr}</span><span class="text-lg font-bold">${dayStr}</span>`;
            
            btn.onclick = () => {
                // Reset styles
                Array.from(scroller.children).forEach(c => c.className = `${baseClass} ${inactiveClass}`);
                btn.className = `${baseClass} ${activeClass}`;
                renderPlans(fullDate);
            };
            scroller.appendChild(btn);
        }

        // --- CHART & CALCULATION LOGIC (Same as before but dark styled) ---
        function updateWalletUI() {
            const rate = parseFloat(document.getElementById('exchangeRate').value);
            let ericTotal = 0, clementTotal = 0, cardSpends = {};
            for(let c in cardRules) cardSpends[c] = 0;
            const expensesByDate = {};

            expensesData.forEach(e => {
                const currentHKD = e.amountJPY * rate;
                if (e.user === 'Eric') ericTotal += currentHKD; else clementTotal += currentHKD;
                if (cardSpends[e.card] !== undefined) cardSpends[e.card] += currentHKD;
                if (!expensesByDate[e.date]) expensesByDate[e.date] = [];
                expensesByDate[e.date].push({...e, currentHKD});
            });

            updateUserChart(ericTotal, clementTotal);
            updateCardCharts(cardSpends);

            document.getElementById('ericTotalDisp').innerText = Math.round(ericTotal).toLocaleString();
            document.getElementById('clementTotalDisp').innerText = Math.round(clementTotal).toLocaleString();
            document.getElementById('grandTotalDisp').innerText = Math.round(ericTotal + clementTotal).toLocaleString();

            renderLedger(expensesByDate);
        }

        let userChartInstance = null;
        function updateUserChart(eric, clement) {
            const ctx = document.getElementById('userChart').getContext('2d');
            if(!userChartInstance) {
                userChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Eric', 'Clement'],
                        datasets: [{ data: [0, 0], backgroundColor: ['#4CC9F0', '#F72585'], borderWidth: 0, hoverOffset: 4 }]
                    },
                    options: { cutout: '75%', plugins: { legend: { display: false } } }
                });
            }
            // Use dummy data if both 0 to show grey ring
            if(eric===0 && clement===0) {
                 userChartInstance.data.datasets[0].data = [1];
                 userChartInstance.data.datasets[0].backgroundColor = ['#333'];
            } else {
                 userChartInstance.data.datasets[0].data = [eric, clement];
                 userChartInstance.data.datasets[0].backgroundColor = ['#4CC9F0', '#F72585'];
            }
            userChartInstance.update();
        }

        function updateCardCharts(spends) {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            let totalRebate = 0;

            for (let cardName in cardRules) {
                const rule = cardRules[cardName];
                const spend = spends[cardName];
                let rebate = 0, statusColor = '#374151'; // Default gray-700
                
                if (spend >= rule.min) {
                    if (spend <= rule.max) {
                        rebate = spend * rule.rate;
                        statusColor = '#22c55e'; // Green
                    } else {
                        rebate = rule.max * rule.rate;
                        statusColor = '#ef4444'; // Red
                    }
                }

                totalRebate += rebate;
                const chartId = `chart-${cardName.replace(/[^a-zA-Z0-9]/g, '')}`;

                const div = document.createElement('div');
                div.className = "flex items-center gap-4 border-b border-gray-800 pb-4 last:border-0";
                div.innerHTML = `
                    <div class="relative w-16 h-16 flex-shrink-0">
                        <canvas id="${chartId}"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-gray-500">
                            ${Math.round((spend/rule.max)*100)}%
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="font-bold text-sm text-gray-200">${cardName}</h4>
                            <span class="text-xs font-bold text-green-400">+HKD ${Math.round(rebate)}</span>
                        </div>
                        <div class="text-xs text-gray-500 mb-1">
                            已簽: $${Math.round(spend).toLocaleString()} / $${rule.max.toLocaleString()}
                        </div>
                    </div>
                `;
                container.appendChild(div);

                const ctx = document.getElementById(chartId).getContext('2d');
                let filled = spend > rule.max ? rule.max : spend;
                let empty = rule.max - filled;
                
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [filled, empty < 0 ? 0 : empty],
                            backgroundColor: [statusColor, '#27272a'],
                            borderWidth: 0
                        }]
                    },
                    options: { cutout: '75%', animation: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
                });
            }
            document.getElementById('totalRebateDisp').innerText = Math.round(totalRebate).toLocaleString();
        }

        function renderLedger(groupedExpenses) {
            const container = document.getElementById('ledgerList');
            container.innerHTML = `<h3 class="font-bold text-gray-500 ml-1">每日明細</h3>`;
            const dates = Object.keys(groupedExpenses).sort().reverse();
            if (dates.length === 0) return container.innerHTML += `<div class="text-center text-sm text-gray-600 py-4">無記錄</div>`;

            dates.forEach(date => {
                const dayTotalJPY = groupedExpenses[date].reduce((sum, e) => sum + e.amountJPY, 0);
                const dayTotalHKD = groupedExpenses[date].reduce((sum, e) => sum + e.currentHKD, 0);
                
                let html = `
                    <div class="bg-dark-card rounded-xl card-shadow overflow-hidden border border-gray-800">
                        <div class="bg-gray-800/50 px-4 py-2 flex justify-between items-center border-b border-gray-700">
                            <span class="font-bold text-gray-300">${date}</span>
                            <div class="text-xs text-right">
                                <div class="text-gray-400">¥${dayTotalJPY.toLocaleString()}</div>
                                <div class="font-bold text-neon-gold">HK$${Math.round(dayTotalHKD).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="p-0">`;

                groupedExpenses[date].forEach(e => {
                    const userColor = e.user === 'Eric' ? 'text-neon-blue' : 'text-neon-pink';
                    html += `
                        <div class="flex justify-between items-center p-3 border-b border-gray-800 last:border-0">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold ${userColor} border px-1 rounded border-current">${e.user[0]}</span>
                                    <span class="text-sm font-medium text-white">${e.item}</span>
                                </div>
                                <div class="text-xs text-gray-500 pl-7">${e.card}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-gray-300">¥${e.amountJPY.toLocaleString()}</div>
                            </div>
                        </div>`;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            });
        }

        // Init Card Options
        const select = document.getElementById('expCard');
        for (let card in cardRules) {
            const opt = document.createElement('option');
            opt.value = card; opt.innerText = card;
            select.appendChild(opt);
        }

    </script>
</body>
  </html>
